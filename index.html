<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessoria de Comunicação Evereste</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Fontes e Estilos Globais -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #0f172a; /* slate-900 */
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Classes utilitárias para esconder/mostrar */
        .hidden-app { display: none !important; }

        /* Impressão Otimizada (Retrato) */
        @media print {
            @page { margin: 0.5cm; size: portrait; }
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                background-color: white;
                font-size: 10px; 
            }
            #app-content {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
                display: block !important; /* Garante que aparece na impressão */
            }
            #login-screen, #mobile-menu, header, footer, .no-print { display: none !important; }
            .print-break-inside-avoid { break-inside: avoid; }
            table { font-size: 9px; width: 100%; table-layout: fixed; }
            th, td { padding: 4px 2px !important; word-wrap: break-word; }
            input, select, textarea {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                resize: none; 
                -webkit-appearance: none;
                appearance: none;
            }
            /* Cores forçadas para impressão */
            .bg-blue-100 { background-color: #dbeafe !important; }
            .bg-blue-900 { background-color: #1e3a8a !important; color: white !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
            .bg-cyan-100 { background-color: #cffafe !important; }
            .bg-purple-100 { background-color: #f3e8ff !important; }
            
            .custom-scrollbar::-webkit-scrollbar { display: none; }
        }

        #modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }

        .nav-btn-active {
            background-color: #ffffff !important;
            color: #1e3a8a !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-weight: 700;
        }
        .nav-btn-inactive { color: #dbeafe !important; }
        .nav-btn-inactive:hover {
            background-color: #1d4ed8 !important;
            color: #ffffff !important;
        }
    </style>
</head>
<body class="pb-12 h-screen flex flex-col">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-slate-900 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 animate-fadeIn">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-900 rounded-lg flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4 shadow-lg">AE</div>
                <h1 class="text-2xl font-bold text-gray-800">Acesso Restrito</h1>
                <p class="text-gray-500 text-sm">Sistema de Gestão Evereste</p>
            </div>

            <form id="auth-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                        </div>
                        <input type="email" id="auth-email" class="pl-10 w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="nome@exemplo.com" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                        </div>
                        <input type="password" id="auth-password" class="pl-10 w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="••••••••" required>
                    </div>
                </div>

                <div id="auth-error" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded border border-red-100"></div>

                <button type="submit" id="btn-login" class="w-full bg-blue-900 text-white font-bold py-3 rounded-lg hover:bg-blue-800 transition shadow-lg flex justify-center items-center">
                    Entrar
                </button>
            </form>

            <div class="mt-6 text-center pt-6 border-t border-gray-100">
                <button id="toggle-auth-mode" class="text-sm text-blue-600 hover:text-blue-800 font-medium">
                    Não tem conta? Criar registo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div id="modal-overlay" class="fixed inset-0 flex items-center justify-center z-50 hidden no-print bg-black/50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full border border-red-100 animate-fadeIn">
            <h3 class="text-lg font-bold text-gray-900 mb-2 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="text-red-500"></i> Confirmação
            </h3>
            <p id="modal-message" class="text-gray-600 mb-6">Tem a certeza que deseja apagar?</p>
            <div class="flex justify-end gap-3">
                <button onclick="window.closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white hover:bg-red-700 rounded-lg shadow-sm">Sim, Apagar</button>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL (Wrapper) -->
    <div id="app-wrapper" class="flex-1 flex flex-col hidden-app">
        
        <!-- Header -->
        <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-40 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white rounded flex items-center justify-center text-blue-900 font-bold shadow-sm">AE</div>
                    <div>
                        <h1 class="text-lg font-bold leading-none hidden md:block">Assessoria de Comunicação Evereste</h1>
                        <h1 class="text-lg font-bold leading-none md:hidden">Evereste</h1>
                        <p class="text-xs text-blue-200 mt-1">Gestão Integrada</p>
                    </div>
                </div>

                <!-- Nav Desktop -->
                <nav class="hidden md:flex gap-1 bg-blue-800/50 p-1 rounded-lg">
                    <button onclick="window.changeView('dashboard')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="dashboard">Dashboard</button>
                    <button onclick="window.changeView('month')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="month">Ações</button>
                    <button onclick="window.changeView('calendar')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="calendar">Calendário</button>
                    <button onclick="window.changeView('reports')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="reports">Relatórios</button>
                    <button onclick="window.changeView('crisis')" class="nav-btn px-4 py-2 rounded-md text-sm font-medium transition-all" data-view="crisis">Riscos</button>
                </nav>

                <div class="flex items-center gap-2">
                    <span id="user-email-display" class="text-xs text-blue-200 hidden md:block mr-2"></span>
                    <button onclick="window.logout()" class="p-2 text-white hover:bg-red-600/80 rounded transition bg-blue-800" title="Sair">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                    <button class="md:hidden p-2 text-white hover:bg-blue-800 rounded" onclick="window.toggleMobileMenu()">
                        <i data-lucide="menu"></i>
                    </button>
                </div>
            </div>

            <div id="mobile-menu" class="hidden md:hidden bg-blue-800 px-4 py-2 space-y-2 border-t border-blue-700">
                <button onclick="window.changeView('dashboard'); window.toggleMobileMenu()" class="block w-full text-left py-3 text-white border-b border-blue-700 font-medium">Dashboard</button>
                <button onclick="window.changeView('month'); window.toggleMobileMenu()" class="block w-full text-left py-3 text-white border-b border-blue-700 font-medium">Ações do Mês</button>
                <button onclick="window.changeView('calendar'); window.toggleMobileMenu()" class="block w-full text-left py-3 text-white border-b border-blue-700 font-medium">Calendário Anual</button>
                <button onclick="window.changeView('reports'); window.toggleMobileMenu()" class="block w-full text-left py-3 text-white border-b border-blue-700 font-medium">Relatórios & Metas</button>
                <button onclick="window.changeView('crisis'); window.toggleMobileMenu()" class="block w-full text-left py-3 text-white font-medium">Riscos & Crises</button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="app-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full flex-1">
            <div id="loading" class="text-center py-20 text-gray-500">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mb-4"></div>
                <p id="loading-text" class="animate-pulse">A carregar dados...</p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="hidden print:block text-center text-xs text-gray-400 mt-12 border-t pt-4 bg-white pb-4 w-full">
            <p class="uppercase font-bold tracking-wider">Assessoria de Comunicação Evereste - Relatório Oficial</p>
            <p>Documento gerado em <span id="print-date"></span> por <span id="print-user"></span></p>
        </footer>
    
    </div> <!-- Fim App Wrapper -->
    
    <!-- Status Indicator -->
    <div id="connection-status" class="fixed bottom-2 right-2 text-[10px] text-gray-400 no-print opacity-50 hover:opacity-100 transition-opacity bg-white px-2 py-1 rounded shadow border z-50">
        A conectar...
    </div>

    <!-- SCRIPT UNIFICADO (FIREBASE + AUTH) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";

        // --- CONSTANTES ---
        const MONTHS_DATA = [
            { id: 0, name: 'Janeiro', color: 'border-l-4 border-gray-200' },
            { id: 1, name: 'Fevereiro', color: 'border-l-4 border-purple-400' },
            { id: 2, name: 'Março', color: 'border-l-4 border-pink-300' },
            { id: 3, name: 'Abril', color: 'border-l-4 border-blue-400' },
            { id: 4, name: 'Maio', color: 'border-l-4 border-yellow-400' },
            { id: 5, name: 'Junho', color: 'border-l-4 border-red-500' },
            { id: 6, name: 'Julho', color: 'border-l-4 border-yellow-500' },
            { id: 7, name: 'Agosto', color: 'border-l-4 border-yellow-600' },
            { id: 8, name: 'Setembro', color: 'border-l-4 border-yellow-300' },
            { id: 9, name: 'Outubro', color: 'border-l-4 border-pink-500' },
            { id: 10, name: 'Novembro', color: 'border-l-4 border-blue-600' },
            { id: 11, name: 'Dezembro', color: 'border-l-4 border-red-600' },
        ];

        const EVENT_TYPES = ['TI', 'Evento Interno', 'Evento Externo', 'Campanha', 'Treinamento', 'Gravação Externa'];
        const AUDIENCE_OPTIONS = ['Externo', 'Interno', 'Parceria', 'Visitante', 'Colaborador'];
        const CRISIS_SECTOR_OPTIONS = ['Comunicação', 'Central', 'Infraestrutura', 'Administração', 'RH', 'Externo'];
        const RISK_LEVELS = ['Sem relevância crítica', 'Leve', 'Moderada', 'Potencial', 'Grave', 'Reputacional Extrema'];
        const ORIGIN_OPTIONS = ['Interno', 'Externo', 'Misto'];
        const RESPONSIBLE_OPTIONS = ['Vera Nascimento', 'Gisely Rocha'];

        // --- CONFIGURAÇÃO FIREBASE ---
        // A chave e configuração são injetadas pelo ambiente.
        // Se undefined, fallback para objeto vazio (o que será tratado no init)
        const __firebase_config_str = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        // --- ESTADO GLOBAL ---
        window.state = {
            view: 'dashboard',
            selectedMonth: new Date().getMonth(),
            activities: [],
            crises: [],
            notifications: [],
            monthlyReports: {},
            holidays: [{ id: 'init', month: 0, day: '01', name: 'Confraternização Universal' }],
            user: null,
            isLoginMode: true // Toggle entre Login e Cadastro
        };

        let db, auth;

        // --- ERROR HANDLER ---
        window.onerror = function(message) {
            console.error("Erro Global:", message);
        };

        // --- FUNÇÕES DE AUTH (INTERFACE) ---
        const toggleAuthBtn = document.getElementById('toggle-auth-mode');
        const btnLogin = document.getElementById('btn-login');
        const form = document.getElementById('auth-form');
        
        if(toggleAuthBtn) {
            toggleAuthBtn.addEventListener('click', (e) => {
                e.preventDefault();
                window.state.isLoginMode = !window.state.isLoginMode;
                if(window.state.isLoginMode) {
                    btnLogin.innerText = "Entrar";
                    toggleAuthBtn.innerText = "Não tem conta? Criar registo";
                } else {
                    btnLogin.innerText = "Criar Conta";
                    toggleAuthBtn.innerText = "Já tem conta? Fazer Login";
                }
                document.getElementById('auth-error').classList.add('hidden');
            });
        }

        if(form) {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const errorDiv = document.getElementById('auth-error');
                
                errorDiv.classList.add('hidden');
                btnLogin.disabled = true;
                btnLogin.innerText = "A processar...";

                if (!auth) {
                    errorDiv.innerText = "Erro: Firebase não inicializado corretamente. Recarregue a página.";
                    errorDiv.classList.remove('hidden');
                    btnLogin.disabled = false;
                    return;
                }

                try {
                    if (window.state.isLoginMode) {
                        // CORREÇÃO CRÍTICA: Passar 'auth' como primeiro argumento
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        // CORREÇÃO CRÍTICA: Passar 'auth' como primeiro argumento
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    // Sucesso: o onAuthStateChanged lidará com a UI
                } catch (error) {
                    console.error("Auth Error:", error);
                    errorDiv.innerText = "Erro: " + error.message;
                    errorDiv.classList.remove('hidden');
                    btnLogin.disabled = false;
                    btnLogin.innerText = window.state.isLoginMode ? "Entrar" : "Criar Conta";
                }
            });
        }

        window.logout = async () => {
            try {
                if(auth) await signOut(auth);
            } catch(e) { console.error(e); }
        };

        // --- FUNÇÕES DE INTERFACE DO SISTEMA ---
        window.changeView = (viewName) => {
            window.state.view = viewName;
            renderApp();
        };

        window.changeMonth = (monthId) => {
            window.state.selectedMonth = parseInt(monthId);
            renderApp();
        };

        window.toggleMobileMenu = () => {
            const menu = document.getElementById('mobile-menu');
            if(menu) menu.classList.toggle('hidden');
        };

        window.handleSave = () => {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="cloud-check"></i> Sincronizado!';
            btn.classList.add('bg-green-700');
            setTimeout(() => { 
                btn.innerHTML = originalText; 
                btn.classList.remove('bg-green-700');
                if(typeof lucide !== 'undefined') lucide.createIcons(); 
            }, 2000);
        };
        
        window.exportPDF = () => setTimeout(() => window.print(), 100);

        window.openConfirmModal = (msg, actionCallback) => {
            const modal = document.getElementById('modal-overlay');
            const msgEl = document.getElementById('modal-message');
            const btn = document.getElementById('modal-confirm-btn');
            if(modal && msgEl && btn) {
                msgEl.innerText = msg;
                btn.onclick = () => { actionCallback(); window.closeModal(); };
                modal.classList.remove('hidden');
            }
        };

        window.closeModal = () => {
            const modal = document.getElementById('modal-overlay');
            if(modal) modal.classList.add('hidden');
        };

        // --- CRUD UNIFICADO ---
        window.addActivity = async () => {
            const data = {
                month: window.state.selectedMonth,
                type: 'Evento Interno', eventName: '', audience: 'Interno', link: '',
                date: '', time: '', postName: '', postOccurrence: '', postAction: '',
                satisfaction: '', status: 'Planejado',
                createdAt: new Date().toISOString(),
                createdBy: window.state.user.email
            };
            try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), data); } 
            catch (e) { console.error("Erro addActivity:", e); }
        };
        
        window.updateUnifiedActivity = async (id, field, value) => {
            try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id), { [field]: value }); } 
            catch (e) { console.error("Erro updateActivity:", e); }
        };
        
        window.requestDeleteActivity = (id) => window.openConfirmModal("Excluir esta ação para todos?", async () => {
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id)); } 
            catch (e) { console.error("Erro deleteActivity:", e); }
        });

        window.addCrisis = async () => {
            const data = {
                date: new Date().toISOString().split('T')[0],
                riskLevel: 'Sem relevância crítica', origin: 'Interno', sector: 'Comunicação', responsible: 'Vera Nascimento',
                correctiveAction: '', risks: '', learning: '', improvement: '',
                createdAt: new Date().toISOString(),
                createdBy: window.state.user.email
            };
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'crises'), data);
        };
        
        window.updateUnifiedCrisis = async (id, field, value) => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'crises', id), { [field]: value });
        };
        
        window.requestDeleteCrisis = (id) => window.openConfirmModal("Excluir este registo?", async () => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'crises', id));
        });

        window.addNotification = async () => {
            const input = document.getElementById('new-notification');
            if(input && input.value.trim()) {
                const data = { text: input.value, timestamp: new Date().toISOString(), author: window.state.user.email };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), data);
                input.value = '';
            }
        };
        
        window.deleteNotification = async (id) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'notifications', id));
        };

        window.addHoliday = async () => {
            const dayInput = document.getElementById('holiday-day');
            const nameInput = document.getElementById('holiday-name');
            if (dayInput && nameInput && dayInput.value && nameInput.value) {
                const data = { month: window.state.selectedMonth, day: dayInput.value, name: nameInput.value };
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'holidays'), data);
            }
        };
        
        window.removeHoliday = (id) => window.openConfirmModal("Apagar data?", async () => {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'holidays', id));
        });

        window.updateUnifiedReport = async (monthId, field, value) => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', monthId.toString()), { [field]: value }, { merge: true });
        };
        
        window.requestClearReport = () => window.openConfirmModal("Limpar relatório?", async () => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', window.state.selectedMonth.toString()), { explanation: '', highlights: '', suggestions: '' });
        });

        window.generateAutoText = () => {
            const monthActs = window.state.activities.filter(a => a.month === window.state.selectedMonth);
            const total = monthActs.length;
            const completed = monthActs.filter(a => a.status === 'Concluído').length;
            const efficiency = total > 0 ? Math.round((completed/total)*100) : 0;
            const text = `ANÁLISE DE ENTREGAS - ${MONTHS_DATA[window.state.selectedMonth].name.toUpperCase()}\n\nO mês encerrou com ${total} ações planejadas e ${completed} metas atingidas. Eficiência de execução: ${efficiency}%.`;
            window.updateUnifiedReport(window.state.selectedMonth, 'explanation', text);
        };
        
        window.generateHighlights = () => {
            const completedActs = window.state.activities.filter(a => a.month === window.state.selectedMonth && a.status === 'Concluído');
            let text = "RESULTADOS CONSOLIDADOS:\n\n";
            if (completedActs.length === 0) text += "- Nenhuma atividade concluída neste período.";
            else completedActs.forEach(act => text += `• ${act.type}: "${act.eventName || 'Evento'}" - Satisfação: ${act.satisfaction || '0'}%\n`);
            window.updateUnifiedReport(window.state.selectedMonth, 'highlights', text);
        };

        // --- RENDERIZAÇÃO ---
        function renderApp() {
            if (!window.state.user) return; // Não renderiza se não logado

            const content = document.getElementById('app-content');
            if(!content) return;

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.view === window.state.view) {
                    btn.className = 'nav-btn nav-btn-active px-4 py-2 rounded-md text-sm font-medium transition-all';
                } else {
                    btn.className = 'nav-btn nav-btn-inactive px-4 py-2 rounded-md text-sm font-medium transition-all';
                }
            });

            // Seletor de mês apenas em views especificas
            let monthSelectorHTML = '';
            if (window.state.view === 'month' || window.state.view === 'reports') {
                monthSelectorHTML = `
                    <div class="mb-8 overflow-x-auto pb-4 no-print">
                        <div class="flex gap-2 min-w-max px-1">
                            ${MONTHS_DATA.map(m => `
                                <button onclick="window.changeMonth(${m.id})" 
                                    class="px-5 py-2.5 rounded-full text-sm font-bold transition-all whitespace-nowrap border shadow-sm
                                    ${window.state.selectedMonth === m.id 
                                        ? 'bg-blue-900 text-white border-blue-900 ring-2 ring-offset-2 ring-blue-900' 
                                        : 'bg-white text-gray-600 hover:bg-gray-50 border-gray-200 hover:border-gray-300'}">
                                    ${m.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            let viewHTML = '';
            if (window.state.view === 'dashboard') viewHTML = getDashboardHTML();
            else if (window.state.view === 'month') viewHTML = getMonthViewHTML();
            else if (window.state.view === 'calendar') viewHTML = getCalendarViewHTML();
            else if (window.state.view === 'crisis') viewHTML = getCrisisViewHTML();
            else if (window.state.view === 'reports') viewHTML = getReportsViewHTML();

            content.innerHTML = monthSelectorHTML + viewHTML;
            if(typeof lucide !== 'undefined') lucide.createIcons();
            attachInputListeners();
        }

        // --- TEMPLATES HTML ---
        function getDashboardHTML() {
            const activities = window.state.activities || [];
            const completedActs = activities.filter(a => a.status === 'Concluído');
            const annualGoal = activities.length; 
            const annualAchieved = completedActs.length;
            const ratedEvents = completedActs.filter(a => a.satisfaction && !isNaN(parseFloat(a.satisfaction)));
            const totalSatisfaction = ratedEvents.reduce((acc, curr) => acc + parseFloat(curr.satisfaction), 0);
            const averageSatisfaction = ratedEvents.length > 0 ? Math.round(totalSatisfaction / ratedEvents.length) : 0;
            const topEvents = activities.filter(a => a.status === 'Concluído' && a.satisfaction).sort((a, b) => parseFloat(b.satisfaction) - parseFloat(a.satisfaction)).slice(0, 5);
            
            const topEventsHTML = topEvents.map((evt, idx) => `<div class="flex items-center justify-between p-3 bg-white border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors"><div class="flex items-center gap-3"><div class="w-6 h-6 flex items-center justify-center bg-yellow-100 text-yellow-700 font-bold rounded-full text-xs">${idx + 1}º</div><div><p class="text-sm font-bold text-gray-800">${evt.eventName || 'Evento'}</p><p class="text-[10px] text-gray-500">${evt.type}</p></div></div><div class="flex items-center gap-1 bg-green-50 px-2 py-1 rounded text-green-700 font-bold text-xs">${evt.satisfaction}% <i data-lucide="star" size="12"></i></div></div>`).join('') || '<p class="text-xs text-gray-400 italic text-center py-4">Sem avaliações.</p>';
            const notificationsHTML = window.state.notifications.map(n => `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-2 rounded shadow-sm flex justify-between items-start"><div><p class="text-sm text-yellow-800 font-medium">${n.text}</p><p class="text-[10px] text-yellow-600 mt-1">${new Date(n.timestamp).toLocaleString()} • ${n.author || 'Anon'}</p></div><button onclick="window.deleteNotification('${n.id}')" class="text-yellow-400 hover:text-yellow-700"><i data-lucide="x" size="14"></i></button></div>`).join('');

            return `<div class="space-y-6 animate-fadeIn"><div class="flex justify-between items-center border-b pb-4"><h2 class="text-2xl font-bold text-gray-800">Dashboard Geral</h2><button onclick="window.exportPDF()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium no-print shadow-sm"><i data-lucide="printer"></i> Exportar PDF</button></div><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-indigo-500"><div class="flex justify-between items-center"><div><p class="text-sm text-gray-500 font-medium">Média Real (Anual)</p><h3 class="text-3xl font-bold text-indigo-700">${averageSatisfaction}%</h3></div><i data-lucide="star" class="text-indigo-500 h-8 w-8 opacity-80"></i></div><div class="w-full bg-gray-200 rounded-full h-1.5 mt-2"><div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${averageSatisfaction}%"></div></div></div><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-blue-600"><div class="flex justify-between items-center"><div><p class="text-sm text-gray-500 font-medium">Meta Anual</p><h3 class="text-3xl font-bold text-gray-800">${annualGoal}</h3></div><i data-lucide="target" class="text-blue-600 h-8 w-8 opacity-80"></i></div></div><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-green-500"><div class="flex justify-between items-center"><div><p class="text-sm text-gray-500 font-medium">Atingidas</p><h3 class="text-3xl font-bold text-gray-800">${annualAchieved}</h3></div><i data-lucide="check-circle-2" class="text-green-500 h-8 w-8 opacity-80"></i></div></div><div class="bg-white p-6 rounded-lg shadow-sm border-l-4 border-red-500"><div class="flex justify-between items-center"><div><p class="text-sm text-gray-500 font-medium">Riscos</p><h3 class="text-3xl font-bold text-gray-800">${window.state.crises.length}</h3></div><i data-lucide="shield-alert" class="text-red-500 h-8 w-8 opacity-80"></i></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 no-print flex flex-col"><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="text-blue-600"></i> Evolução</h3><div class="h-48 flex items-end gap-2 justify-between px-2">${MONTHS_DATA.map(m => { const c = activities.filter(a => a.month === m.id).length; const h = c > 0 ? Math.min((c/15)*100,100) : 4; return `<div class="flex flex-col items-center flex-1 group relative"><span class="text-xs font-bold text-blue-600 mb-1 absolute bottom-full">${c}</span><div class="w-full rounded-t ${c>0?'bg-blue-500':'bg-gray-100'}" style="height:${h}%"></div><span class="text-xs text-gray-500 mt-2 truncate text-center">${m.name.substring(0,3)}</span></div>`}).join('')}</div></div><div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 no-print flex flex-col h-full"><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="trophy" class="text-yellow-500"></i> Top Eventos</h3><div class="flex-1 overflow-y-auto custom-scrollbar max-h-[200px]">${topEventsHTML}</div></div><div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 no-print flex flex-col h-full"><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i data-lucide="bell" class="text-yellow-500"></i> Mural</h3><div class="flex gap-2 mb-4"><input type="text" id="new-notification" placeholder="Aviso..." class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm"><button onclick="window.addNotification()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Postar</button></div><div class="overflow-y-auto flex-1 custom-scrollbar max-h-[200px]">${notificationsHTML}</div></div></div></div>`;
        }

        function getMonthViewHTML() {
            const month = MONTHS_DATA[window.state.selectedMonth];
            const monthHolidays = window.state.holidays.filter(h => parseInt(h.month) === window.state.selectedMonth);
            const monthActs = window.state.activities.filter(a => parseInt(a.month) === window.state.selectedMonth);
            
            const getTypeColor = (t) => t==='TI'?'bg-purple-100 text-purple-800':t==='Evento Interno'?'bg-blue-100 text-blue-800':t==='Evento Externo'?'bg-indigo-100 text-indigo-800':t==='Campanha'?'bg-pink-100 text-pink-800':t==='Treinamento'?'bg-orange-100 text-orange-800':'bg-cyan-100 text-cyan-800';
            const getStatusColor = (s) => s==='Concluído'?{bg:'#dcfce7',txt:'#166534'}:s==='Planejado'?{bg:'#fef9c3',txt:'#854d0e'}:{bg:'#fee2e2',txt:'#991b1b'};

            return `
                <div class="space-y-8 animate-fadeIn">
                    <div class="bg-white p-6 rounded-lg shadow-sm ${month.color}"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800 uppercase">${month.name}</h2><div class="flex gap-2 no-print"><button onclick="window.handleSave()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium"><i data-lucide="cloud-upload" size="16"></i> Salvar / Sincronizar</button><button onclick="window.exportPDF()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"><i data-lucide="printer" size="16"></i> Exportar PDF</button></div></div><div class="mt-6 pt-4 border-t border-gray-100"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 gap-2"><h4 class="text-xs font-bold text-gray-500 uppercase">Datas Comemorativas</h4><div class="flex gap-2 no-print bg-gray-50 p-1 rounded items-center"><input type="text" id="holiday-day" placeholder="Dia" class="w-16 border border-gray-300 rounded px-2 py-1 text-xs"><input type="text" id="holiday-name" placeholder="Evento" class="w-32 border border-gray-300 rounded px-2 py-1 text-xs"><button onclick="window.addHoliday()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold hover:bg-blue-700">Adicionar</button></div></div><div class="flex flex-wrap gap-2">${monthHolidays.map(h => `<div class="flex items-center gap-2 px-3 py-1 bg-blue-50 text-blue-800 text-xs rounded-full border border-blue-100"><span class="font-bold">${h.day}</span> - ${h.name}<button onclick="window.removeHoliday('${h.id}')" class="text-red-400 hover:text-red-600 ml-1 no-print"><i data-lucide="x" size="12"></i></button></div>`).join('')}</div></div></div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"><div class="flex justify-between items-center p-4 border-b bg-gray-50"><h3 class="font-bold text-gray-700 flex items-center gap-2"><i data-lucide="file-text" class="text-blue-600"></i> Cronograma</h3><button onclick="window.addActivity()" class="flex items-center gap-1 text-sm bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 no-print"><i data-lucide="plus" size="14"></i> Adicionar Ação</button></div><div class="overflow-x-auto custom-scrollbar"><table class="w-full text-sm text-left whitespace-nowrap"><thead class="bg-gray-100 text-gray-700 font-semibold uppercase text-xs"><tr><th class="px-4 py-3 min-w-[140px]">Tipo</th><th class="px-4 py-3 min-w-[200px]">Nome</th><th class="px-4 py-3 min-w-[120px]">Público</th><th class="px-4 py-3 min-w-[170px]">Data/Hora</th><th class="px-4 py-3 min-w-[120px]">Link</th><th class="px-4 py-3 min-w-[150px]">Ocorrência</th><th class="px-4 py-3 min-w-[150px]">Tomada</th><th class="px-4 py-3 min-w-[120px]">Satisfação</th><th class="px-4 py-3 min-w-[100px]">Status</th><th class="px-4 py-3 w-[50px] no-print">Ações</th></tr></thead><tbody class="divide-y divide-gray-100">${monthActs.map(act => { const st = getStatusColor(act.status); const satisfactionWidth = act.satisfaction ? Math.min(act.satisfaction, 100) : 0; return `<tr class="hover:bg-gray-50 align-top"><td class="px-4 py-3"><select onchange="window.updateUnifiedActivity('${act.id}', 'type', this.value)" class="w-full border rounded text-xs p-1.5 ${getTypeColor(act.type)} font-bold">${EVENT_TYPES.map(opt => `<option ${act.type === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select></td><td class="px-4 py-3"><input type="text" value="${act.eventName || ''}" data-id="${act.id}" data-field="eventName" class="act-input w-full bg-white border border-gray-300 rounded text-xs p-1.5 font-medium"></td><td class="px-4 py-3"><select onchange="window.updateUnifiedActivity('${act.id}', 'audience', this.value)" class="w-full bg-white border border-gray-300 rounded text-xs p-1.5">${AUDIENCE_OPTIONS.map(opt => `<option ${act.audience === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select></td><td class="px-4 py-3"><div class="flex flex-col gap-1"><input type="date" value="${act.date || ''}" min="2026-01-01" max="2026-12-31" data-id="${act.id}" data-field="date" class="act-input w-full border border-gray-300 rounded text-sm p-1"><input type="time" value="${act.time || ''}" data-id="${act.id}" data-field="time" class="act-input w-full border border-gray-300 rounded text-sm p-1"></div></td><td class="px-4 py-3"><input type="text" value="${act.link || ''}" data-id="${act.id}" data-field="link" class="act-input w-full border border-gray-300 rounded text-xs p-1.5 text-blue-600"></td><td class="px-4 py-3"><div class="flex flex-col gap-1"><input type="text" value="${act.postName || ''}" data-id="${act.id}" data-field="postName" placeholder="Resp." class="act-input w-full border border-gray-200 rounded text-[10px] p-1 bg-gray-50"><textarea data-id="${act.id}" data-field="postOccurrence" class="act-input w-full border border-gray-300 rounded p-1 text-xs h-12 resize-none">${act.postOccurrence || ''}</textarea></div></td><td class="px-4 py-3"><textarea data-id="${act.id}" data-field="postAction" class="act-input w-full border border-gray-300 rounded p-1 text-xs h-16 resize-none bg-yellow-50">${act.postAction || ''}</textarea></td><td class="px-4 py-3"><div class="flex items-center gap-1 mb-1"><input type="number" value="${act.satisfaction || ''}" data-id="${act.id}" data-field="satisfaction" class="act-input w-12 border border-gray-300 rounded text-xs p-1 text-center font-bold" min="0" max="100"><span class="text-xs text-gray-500">%</span></div><div class="w-full bg-gray-200 rounded-full h-1.5"><div class="bg-green-500 h-1.5 rounded-full" style="width: ${satisfactionWidth}%"></div></div></td><td class="px-4 py-3"><select onchange="window.updateUnifiedActivity('${act.id}', 'status', this.value)" class="w-full text-xs font-bold rounded p-1.5 cursor-pointer border-none" style="background-color: ${st.bg}; color: ${st.txt}">${['Planejado','Em Execução','Concluído','Cancelado'].map(s => `<option ${act.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></td><td class="px-4 py-3 text-center no-print"><button onclick="window.requestDeleteActivity('${act.id}')" class="text-gray-400 hover:text-red-600 p-1"><i data-lucide="trash-2" size="16"></i></button></td></tr>` }).join('')}</tbody></table></div></div>
                </div>
            `;
        }

        function getCalendarViewHTML() {
            const activities = window.state.activities || [];
            return `
                <div class="space-y-6 animate-fadeIn">
                     <div class="flex justify-between items-center border-b pb-4"><h2 class="text-2xl font-bold text-gray-800">Calendário Anual Consolidado</h2><button onclick="window.exportPDF()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium no-print shadow-sm"><i data-lucide="printer"></i> Exportar</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${MONTHS_DATA.map(m => {
                            const mActs = activities.filter(a => parseInt(a.month) === m.id);
                            const total = mActs.length;
                            const achieved = mActs.filter(a => a.status === 'Concluído').length;
                            return `<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden print-break-inside-avoid flex flex-col h-auto min-h-[150px]"><div class="px-4 py-3 ${m.color} bg-gray-50 border-b border-gray-100 flex justify-between items-center"><h3 class="font-bold text-gray-800">${m.name}</h3><span class="text-xs font-bold bg-white px-2 py-1 rounded shadow-sm border text-gray-500">${total} Ações</span></div><div class="p-4 flex-1"><h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Eventos:</h4><ul class="space-y-1 mb-4">${mActs.length > 0 ? mActs.map(act => `<li class="text-xs text-gray-700 flex items-start gap-2"><span class="w-1.5 h-1.5 rounded-full bg-blue-400 mt-1 flex-shrink-0"></span><span title="${act.eventName || 'Sem nome'}">${act.eventName || 'Sem nome'}</span></li>`).join('') : '<li class="text-xs text-gray-300 italic">Nenhum evento</li>'}</ul></div><div class="px-4 py-3 bg-gray-50 border-t border-gray-100 flex justify-between text-xs mt-auto"><span class="text-green-600 font-bold">Concluídos: ${achieved}</span><span class="text-gray-500">Planejados: ${total}</span></div></div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getCrisisViewHTML() {
            const crises = window.state.crises || [];
            const getRiskColor = (l) => l.includes('Grave')||l.includes('Extrema')?'text-red-600':l.includes('Moderada')?'text-orange-600':'text-gray-700';
            return `
                <div class="space-y-6 animate-fadeIn">
                    <div class="bg-red-50 p-6 rounded-lg border border-red-100 flex flex-col md:flex-row justify-between items-start gap-4"><div><h2 class="text-2xl font-bold text-red-800 mb-2 flex items-center gap-2"><i data-lucide="shield-alert"></i> Gestão de Riscos</h2><p class="text-red-700 text-sm max-w-2xl">Classificação de riscos e preenchimento manual.</p></div><div class="flex gap-2 no-print w-full md:w-auto"><button onclick="window.handleSave()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"><i data-lucide="cloud-upload" size="16"></i> Salvar / Sincronizar</button><button onclick="window.exportPDF()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i data-lucide="printer" size="16"></i> Exportar PDF</button></div></div>
                    <button onclick="window.addCrisis()" class="w-full py-4 border-2 border-dashed border-red-300 rounded-lg text-red-600 hover:bg-red-50 hover:border-red-400 transition-colors font-bold uppercase tracking-wide no-print flex items-center justify-center gap-2"><i data-lucide="plus" size="20"></i> Registrar Novo Risco ou Ocorrência</button>
                    <div class="grid gap-6">
                        ${crises.map((item, index) => `<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 relative print-break-inside-avoid"><div class="absolute top-4 right-4 no-print"><button onclick="window.requestDeleteCrisis('${item.id}')" class="flex items-center gap-1 text-gray-400 hover:text-red-600 bg-white border border-gray-200 hover:border-red-200 rounded px-2 py-1 text-xs font-bold"><i data-lucide="trash-2" size="14"></i> Apagar</button></div><h3 class="font-bold text-gray-800 mb-4 border-b pb-2 flex items-center gap-2"><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs">#${index + 1}</span> Ocorrência de Setor</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 bg-gray-50 p-4 rounded-md border border-gray-100"><div><label class="block text-xs font-bold text-gray-500 mb-1">Nível de Risco</label><select onchange="window.updateUnifiedCrisis('${item.id}', 'riskLevel', this.value)" class="w-full border rounded p-2 text-sm font-bold ${getRiskColor(item.riskLevel)}">${RISK_LEVELS.map(r => `<option ${item.riskLevel === r ? 'selected' : ''}>${r}</option>`).join('')}</select></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Origem</label><select onchange="window.updateUnifiedCrisis('${item.id}', 'origin', this.value)" class="w-full border border-gray-300 rounded p-2 text-sm">${ORIGIN_OPTIONS.map(o => `<option ${item.origin === o ? 'selected' : ''}>${o}</option>`).join('')}</select></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Setor</label><select onchange="window.updateUnifiedCrisis('${item.id}', 'sector', this.value)" class="w-full border border-gray-300 rounded p-2 text-sm">${CRISIS_SECTOR_OPTIONS.map(s => `<option ${item.sector === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Responsável</label><select onchange="window.updateUnifiedCrisis('${item.id}', 'responsible', this.value)" class="w-full border border-gray-300 rounded p-2 text-sm">${RESPONSIBLE_OPTIONS.map(r => `<option ${item.responsible === r ? 'selected' : ''}>${r}</option>`).join('')}</select></div></div><div class="mb-4"><label class="block text-xs font-bold text-gray-500 mb-1 uppercase text-red-600 flex items-center gap-1"><i data-lucide="alert-triangle" size="12"></i> Plano de Ação Corretiva</label><textarea data-cid="${item.id}" data-cfield="correctiveAction" class="crisis-input w-full border border-red-100 bg-white rounded p-3 text-sm focus:ring-red-500 min-h-[80px]" placeholder="Descreva ação tomada...">${item.correctiveAction}</textarea></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-gray-50 p-3 rounded border border-gray-100"><label class="block text-xs font-bold text-gray-600 mb-1">Impactos / Riscos</label><textarea data-cid="${item.id}" data-cfield="risks" class="crisis-input w-full bg-white border border-gray-200 rounded p-2 text-xs h-24 resize-none">${item.risks}</textarea></div><div class="bg-blue-50 p-3 rounded border border-blue-100"><label class="block text-xs font-bold text-blue-800 mb-1">Aprendizados</label><textarea data-cid="${item.id}" data-cfield="learning" class="crisis-input w-full bg-white border border-blue-200 rounded p-2 text-xs h-24 resize-none">${item.learning}</textarea></div><div class="bg-green-50 p-3 rounded border border-green-100"><label class="block text-xs font-bold text-green-800 mb-1">Melhoria Futura</label><textarea data-cid="${item.id}" data-cfield="improvement" class="crisis-input w-full bg-white border border-green-200 rounded p-2 text-xs h-24 resize-none">${item.improvement}</textarea></div></div></div>`).join('')}${crises.length === 0 ? `<div class="text-center py-12 bg-white rounded-lg border border-dashed border-gray-300"><i data-lucide="shield-check" class="mx-auto h-12 w-12 text-gray-300 mb-3"></i><p class="text-gray-500 font-medium">Nenhum risco ou ocorrência registrada.</p></div>` : ''}
                    </div>
                </div>
            `;
        }

        function getReportsViewHTML() {
            const activities = window.state.activities || [];
            const monthActs = activities.filter(a => parseInt(a.month) === window.state.selectedMonth);
            const total = monthActs.length;
            const completed = monthActs.filter(a => a.status === 'Concluído').length;
            const missed = total - completed;
            const internal = monthActs.filter(a => a.type === 'Evento Interno').length;
            const ratedMonthActs = monthActs.filter(a => a.satisfaction && !isNaN(parseFloat(a.satisfaction)));
            const totalMonthSat = ratedMonthActs.reduce((acc, curr) => acc + parseFloat(curr.satisfaction), 0);
            const avgMonthSat = ratedMonthActs.length > 0 ? Math.round(totalMonthSat / ratedMonthActs.length) : 0;
            const report = (window.state.monthlyReports && window.state.monthlyReports[window.state.selectedMonth]) || { explanation: '', highlights: '', suggestions: '' };

            return `
                <div class="space-y-8 animate-fadeIn max-w-5xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 gap-4"><div><h2 class="text-2xl font-bold text-gray-800">Relatório de Desempenho e Metas</h2><p class="text-gray-500">Mês de Referência: <span class="font-bold text-blue-600">${MONTHS_DATA[window.state.selectedMonth].name}</span></p></div><div class="flex gap-2 no-print w-full md:w-auto flex-wrap"><button onclick="window.exportPDF()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 font-bold"><i data-lucide="file-check-2" size="16"></i> Exportar para Alta Gestão</button><button onclick="window.requestClearReport()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded hover:bg-red-200"><i data-lucide="eraser" size="16"></i> Apagar</button><button onclick="window.handleSave()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"><i data-lucide="cloud-upload" size="16"></i> Salvar / Sincronizar</button></div></div>
                    <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm"><h3 class="text-sm font-bold text-gray-500 uppercase mb-4 border-b pb-2">Metas Consolidadas do Mês</h3><div class="grid grid-cols-2 md:grid-cols-5 gap-4"><div class="p-4 bg-gray-50 rounded text-center"><div class="text-3xl font-bold text-gray-800">${total}</div><div class="text-xs font-bold text-gray-500 uppercase mt-1">Meta Mensal (Ações)</div></div><div class="p-4 bg-green-50 rounded text-center"><div class="text-3xl font-bold text-green-600">${completed}</div><div class="text-xs font-bold text-green-800 uppercase mt-1">Metas Atingidas</div></div><div class="p-4 bg-yellow-50 rounded text-center"><div class="text-3xl font-bold text-yellow-600">${missed}</div><div class="text-xs font-bold text-yellow-800 uppercase mt-1">Não Alcançadas</div></div><div class="p-4 bg-blue-50 rounded text-center"><div class="text-3xl font-bold text-blue-600">${internal}</div><div class="text-xs font-bold text-blue-800 uppercase mt-1">Eventos Internos</div></div><div class="p-4 bg-indigo-50 rounded text-center border border-indigo-100"><div class="text-3xl font-bold text-indigo-600">${avgMonthSat}%</div><div class="text-xs font-bold text-indigo-800 uppercase mt-1">Média Satisfação</div></div></div></div>
                    <div class="space-y-6"><div class="bg-white p-6 rounded shadow-sm border border-gray-200"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-gray-800 text-lg">1. Análise Direta</h3><button onclick="window.generateAutoText()" class="flex items-center gap-1 text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full hover:bg-blue-200 font-bold no-print"><i data-lucide="wand-2" size="12"></i> Gerar Análise</button></div><textarea id="report-explanation" oninput="window.updateUnifiedReport('${window.state.selectedMonth}', 'explanation', this.value)" class="w-full border border-gray-300 rounded p-4 h-48 focus:ring-blue-500 resize-none leading-relaxed text-sm text-gray-700" placeholder="Escreva a análise da alta gestão...">${report.explanation || ''}</textarea></div><div class="bg-white p-6 rounded shadow-sm border border-gray-200"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-gray-800 text-lg">2. Pontos Altos</h3><button onclick="window.generateHighlights()" class="flex items-center gap-1 text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full hover:bg-green-200 font-bold no-print"><i data-lucide="wand-2" size="12"></i> Gerar Destaques</button></div><textarea id="report-highlights" oninput="window.updateUnifiedReport('${window.state.selectedMonth}', 'highlights', this.value)" class="w-full border border-gray-300 rounded p-4 h-32 focus:ring-green-500 resize-none text-sm" placeholder="Liste resultados...">${report.highlights || ''}</textarea></div></div>
                </div>
            `;
        }

        function attachInputListeners() {
            document.querySelectorAll('.act-input').forEach(input => {
                input.addEventListener('change', (e) => { 
                    window.updateUnifiedActivity(e.target.dataset.id, e.target.dataset.field, e.target.value);
                });
            });
            document.querySelectorAll('.crisis-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    window.updateUnifiedCrisis(e.target.dataset.cid, e.target.dataset.cfield, e.target.value);
                });
            });
        }

        // --- INICIALIZAÇÃO ---
        async function initSystem() {
            const dateEl = document.getElementById('print-date');
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString();

            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                // If config is missing, check if using local fallback mode intended? 
                // For now, assume config is required.
                const loading = document.getElementById('loading');
                if(loading) loading.innerHTML = '<div class="text-red-500">Erro: Configuração Firebase ausente.</div>';
                return;
            }

            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                const loginScreen = document.getElementById('login-screen');
                const appWrapper = document.getElementById('app-wrapper');
                const connStatus = document.getElementById('connection-status');
                const userEmailDisplay = document.getElementById('user-email-display');
                const printUser = document.getElementById('print-user');

                if (user) {
                    window.state.user = user;
                    if(loginScreen) loginScreen.classList.add('hidden');
                    if(appWrapper) appWrapper.classList.remove('hidden-app');
                    if(connStatus) connStatus.innerText = 'Online (Sincronizado)';
                    if(userEmailDisplay) userEmailDisplay.innerText = user.email;
                    if(printUser) printUser.innerText = user.email;
                    
                    setupRealtimeListeners();
                } else {
                    window.state.user = null;
                    if(loginScreen) loginScreen.classList.remove('hidden');
                    if(appWrapper) appWrapper.classList.add('hidden-app');
                    if(connStatus) connStatus.innerText = 'A aguardar login...';
                }
            });
        }

        function setupRealtimeListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), (s) => { 
                window.state.activities = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                renderApp(); 
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'crises'), (s) => { 
                window.state.crises = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                renderApp(); 
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), (s) => { 
                window.state.notifications = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); 
                renderApp(); 
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'holidays'), (s) => { 
                const h = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                if(h.length) window.state.holidays = h; 
                renderApp(); 
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), (s) => { 
                const r = {}; 
                s.docs.forEach(d => r[d.id] = d.data()); 
                window.state.monthlyReports = r; 
                renderApp(); 
            });
        }

        initSystem();

    </script>
</body>
</html>
