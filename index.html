
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Gestão de Crises | Instituto Evereste</title>
    
    <!-- Bibliotecas Externas (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Biblioteca leve para Hashes (Simulação de Segurança) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Configuração Tailwind & Estilos Customizados -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Estilos Base */
        body { @apply bg-slate-50 text-slate-800; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Componentes Utilitários */
        .card { @apply bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden; }
        .input-field { @apply w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-600 focus:border-brand-600 outline-none transition-all duration-200 bg-white text-sm; }
        .input-label { @apply block text-sm font-medium text-slate-700 mb-1.5; }
        .btn { @apply px-4 py-2.5 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 text-sm active:scale-95; }
        .btn-primary { @apply bg-brand-700 hover:bg-brand-800 text-white shadow-lg shadow-brand-700/20; }
        .btn-secondary { @apply bg-white hover:bg-slate-50 text-slate-700 border border-slate-300 shadow-sm; }
        .btn-danger { @apply bg-red-600 hover:bg-red-700 text-white shadow-lg shadow-red-600/20; }
        
        /* Modal Overlay */
        .modal-overlay { @apply fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none; }
        .modal-overlay.show { @apply opacity-100 pointer-events-auto; }
        .modal-content { @apply bg-white w-full max-w-md p-6 rounded-2xl shadow-2xl transform transition-all duration-300 scale-95 opacity-0; }
        .modal-overlay.show .modal-content { @apply scale-100 opacity-100; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 rounded-full; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-slate-400; }

        /* Toast Container */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { @apply px-4 py-3 rounded-lg shadow-xl text-white text-sm font-medium flex items-center gap-3 min-w-[320px] max-w-md transform transition-all duration-300 translate-x-full opacity-0; }
        .toast.show { @apply translate-x-0 opacity-100; }
        .toast-success { @apply bg-emerald-600; }
        .toast-error { @apply bg-red-600; }
        .toast-warning { @apply bg-amber-500; }
        .toast-info { @apply bg-blue-600; }
    </style>
</head>
<body>

    <!-- NOTIFICAÇÕES -->
    <div id="toast-container"></div>

    <!-- MODAL DE CONFIRMAÇÃO -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center gap-4 mb-4">
                <div class="p-3 bg-red-100 rounded-full text-red-600">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-900" id="modal-title">Confirmar Ação</h3>
                    <p class="text-sm text-slate-500" id="modal-desc">Você tem certeza que deseja prosseguir?</p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="Modal.close()" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- 1. TELA DE LOGIN (Protegida) -->
    <div id="login-view" class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
        <!-- Background Decorativo -->
        <div class="absolute inset-0 z-0 opacity-10 bg-[radial-gradient(#2563eb_1px,transparent_1px)] [background-size:16px_16px]"></div>
        
        <div class="w-full max-w-md bg-white/80 backdrop-blur-xl p-8 rounded-2xl shadow-2xl border border-white/50 z-10 fade-in">
            <div class="text-center mb-8">
                <div class="inline-flex p-3 bg-brand-50 rounded-2xl mb-4 shadow-inner">
                    <i data-lucide="shield-check" class="w-10 h-10 text-brand-700"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-900">Acesso Corporativo</h1>
                <p class="text-slate-500 text-sm mt-2">Sistema de Gestão de Crise de Imagem</p>
            </div>

            <form id="login-form" onsubmit="AuthService.login(event)" class="space-y-5">
                <div>
                    <label class="input-label">E-mail Institucional</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="email" id="email" class="input-field pl-10" placeholder="usuario@evereste.org.br" required autocomplete="username">
                    </div>
                </div>
                
                <div>
                    <label class="input-label">Senha de Acesso</label>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="password" id="password" class="input-field pl-10" placeholder="••••••••" required autocomplete="current-password">
                    </div>
                </div>

                <!-- 2FA Oculto inicialmente -->
                <div id="2fa-container" class="hidden space-y-4 pt-4 border-t border-slate-100">
                    <div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-xs flex items-start gap-2">
                        <i data-lucide="smartphone" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                        <span>Um código de verificação foi enviado para seu dispositivo móvel cadastrado. (Simulação: <strong>123456</strong>)</span>
                    </div>
                    <div>
                        <label class="input-label">Código de Segurança (2FA)</label>
                        <input type="text" id="2fa-code" maxlength="6" class="input-field text-center text-2xl tracking-[0.5em] font-mono" placeholder="000000">
                    </div>
                </div>

                <button type="submit" id="login-btn" class="btn btn-primary w-full py-3 text-base shadow-brand-700/30">
                    Iniciar Sessão Segura
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-slate-400 flex items-center justify-center gap-1">
                    <i data-lucide="lock" class="w-3 h-3"></i> Conexão Criptografada (TLS 1.3)
                </p>
            </div>
        </div>
    </div>

    <!-- 2. SISTEMA PRINCIPAL (Layout Dashboard) -->
    <div id="app-view" class="hidden flex h-screen overflow-hidden bg-slate-50">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl flex flex-col">
            <div class="p-6 border-b border-slate-800 bg-slate-950/50">
                <div class="flex items-center gap-3">
                    <div class="p-1.5 bg-brand-600 rounded-lg"><i data-lucide="mountain" class="w-6 h-6"></i></div>
                    <div>
                        <h2 class="font-bold tracking-wide text-lg">EVERESTE</h2>
                        <p class="text-[10px] text-slate-400 uppercase tracking-wider font-semibold">Gestão de Crises</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2">Monitoramento</p>
                <button onclick="Router.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-brand-400 transition-colors"></i> Dashboard
                </button>
                <button onclick="Router.navigate('list')" id="nav-list" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="list-todo" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-brand-400 transition-colors"></i> Ocorrências
                </button>

                <p class="px-3 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6">Ações</p>
                <button onclick="Router.navigate('register')" id="nav-register" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="file-plus-2" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-emerald-400 transition-colors"></i> Nova Ocorrência
                </button>
                <button onclick="Router.navigate('charts')" id="nav-charts" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="pie-chart" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-blue-400 transition-colors"></i> Gráficos
                </button>
                <button onclick="Router.navigate('reports')" id="nav-reports" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="file-bar-chart-2" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-purple-400 transition-colors"></i> Relatórios
                </button>
                <button onclick="Router.navigate('config')" id="nav-config" class="nav-item w-full flex items-center px-3 py-2.5 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition-colors group">
                    <i data-lucide="settings" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-gray-400 transition-colors"></i> Configurações
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800 bg-slate-950/30">
                <div class="flex items-center gap-3 mb-4 px-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-brand-500 to-purple-500 flex items-center justify-center text-xs font-bold">AD</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-medium text-white truncate">Administrador</p>
                        <p class="text-xs text-slate-500 truncate">Segurança Nível 3</p>
                    </div>
                </div>
                <button onclick="AuthService.logout()" class="w-full btn bg-slate-800 hover:bg-red-900/30 text-slate-300 hover:text-red-400 border border-slate-700 hover:border-red-900/50 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Área Principal -->
        <main class="flex-1 md:ml-64 flex flex-col h-screen overflow-hidden">
            <!-- Topbar Mobile -->
            <header class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center z-40">
                <div class="flex items-center gap-2 font-bold text-brand-800"><i data-lucide="mountain"></i> EVERESTE</div>
                <button onclick="document.getElementById('sidebar').classList.toggle('-translate-x-full')" class="text-slate-600"><i data-lucide="menu"></i></button>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                
                <!-- VIEW: DASHBOARD -->
                <div id="view-dashboard" class="view-page fade-in space-y-6">
                    <div class="flex flex-col md:flex-row justify-between md:items-end gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Visão Geral</h2>
                            <p class="text-slate-500 text-sm">Monitoramento em tempo real da reputação.</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="App.askClearAll()" class="btn btn-secondary text-red-600 hover:bg-red-50 border-red-200 shadow-none"><i data-lucide="trash-2" class="w-4 h-4"></i> Limpar Tudo</button>
                            <button onclick="Router.navigate('register')" class="btn btn-primary"><i data-lucide="plus" class="w-4 h-4"></i> Nova Ocorrência</button>
                            <button onclick="ReportsService.exportFullReport()" class="btn btn-secondary"><i data-lucide="download" class="w-4 h-4"></i> Relatório PDF</button>
                        </div>
                    </div>

                    <!-- KPIs -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="card p-5 border-l-4 border-l-red-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Crises Ativas</p>
                            <div class="mt-2 flex justify-between items-end">
                                <span id="kpi-active" class="text-3xl font-bold text-slate-900">0</span>
                                <span class="text-red-600 bg-red-50 p-1.5 rounded-lg"><i data-lucide="activity" class="w-5 h-5"></i></span>
                            </div>
                        </div>
                        <div class="card p-5 border-l-4 border-l-brand-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Registrado</p>
                            <div class="mt-2 flex justify-between items-end">
                                <span id="kpi-total" class="text-3xl font-bold text-slate-900">0</span>
                                <span class="text-brand-600 bg-brand-50 p-1.5 rounded-lg"><i data-lucide="database" class="w-5 h-5"></i></span>
                            </div>
                        </div>
                        <div class="card p-5 border-l-4 border-l-emerald-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Resolvidas (Mês)</p>
                            <div class="mt-2 flex justify-between items-end">
                                <span class="text-3xl font-bold text-slate-900" id="kpi-resolved">0</span>
                                <span class="text-emerald-600 bg-emerald-50 p-1.5 rounded-lg"><i data-lucide="check-circle-2" class="w-5 h-5"></i></span>
                            </div>
                        </div>
                        <div class="card p-5 border-l-4 border-l-amber-500">
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Índice de Risco</p>
                            <div class="mt-2 flex justify-between items-end">
                                <span class="text-3xl font-bold text-slate-900" id="kpi-risk">0.0</span>
                                <span class="text-amber-600 bg-amber-50 p-1.5 rounded-lg"><i data-lucide="bar-chart-3" class="w-5 h-5"></i></span>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card p-6 lg:col-span-2">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i data-lucide="trending-up" class="w-4 h-4 mr-2 text-brand-600"></i> Tendência Temporal</h3>
                            <div class="h-72 w-full"><canvas id="chart-trend"></canvas></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-bold text-slate-800 mb-6 flex items-center"><i data-lucide="pie-chart" class="w-4 h-4 mr-2 text-purple-600"></i> Distribuição de Risco</h3>
                            <div class="h-64 w-full flex justify-center"><canvas id="chart-severity"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LISTAGEM -->
                <div id="view-list" class="view-page hidden space-y-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Ocorrências</h2>
                        <div class="flex w-full sm:w-auto gap-2">
                            <div class="relative flex-grow">
                                <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="search-input" onkeyup="App.renderTable()" placeholder="Buscar..." class="input-field pl-10 py-2">
                            </div>
                            <button class="btn btn-secondary px-3"><i data-lucide="filter" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">ID</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider cursor-pointer hover:text-brand-600" onclick="App.sort('data')">Data <i data-lucide="arrow-up-down" class="inline w-3 h-3"></i></th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Fato Gerador</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Responsável</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Risco</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y divide-slate-100 bg-white text-sm text-slate-700">
                                    <!-- Inserido via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-between items-center">
                            <span class="text-xs text-slate-500" id="table-counter">0 registros</span>
                            <div class="flex gap-2">
                                <button class="p-1.5 rounded hover:bg-white border border-transparent hover:border-slate-200 disabled:opacity-50" disabled><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                <button class="p-1.5 rounded hover:bg-white border border-transparent hover:border-slate-200 disabled:opacity-50" disabled><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: REGISTRO -->
                <div id="view-register" class="view-page hidden max-w-4xl mx-auto pb-10">
                    <div class="flex items-center gap-4 mb-6">
                        <button onclick="Router.navigate('dashboard')" class="p-2 rounded-full hover:bg-slate-200 transition"><i data-lucide="arrow-left" class="w-5 h-5 text-slate-600"></i></button>
                        <h2 class="text-2xl font-bold text-slate-800">Novo Registro</h2>
                    </div>

                    <form id="form-create" onsubmit="App.submitForm(event)" class="space-y-6">
                        <!-- Seção 1 -->
                        <div class="card p-6">
                            <h3 class="font-bold text-brand-800 border-b border-slate-100 pb-3 mb-4 flex items-center"><i data-lucide="user" class="w-5 h-5 mr-2"></i> 1. Identificação</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div>
                                    <label class="input-label">Data do Registro</label>
                                    <!-- Data manual conforme solicitado -->
                                    <input type="datetime-local" id="reg-data" class="input-field" required>
                                </div>
                                <div>
                                    <label class="input-label required-label">Responsável</label>
                                    <input type="text" id="reg-resp" class="input-field" placeholder="Nome Completo" required>
                                </div>
                                <div>
                                    <label class="input-label required-label">Cargo/Setor</label>
                                    <input type="text" id="reg-cargo" class="input-field" required>
                                </div>
                                <div>
                                    <label class="input-label required-label">Contato</label>
                                    <input type="tel" id="reg-contato" class="input-field" placeholder="(XX) 9XXXX-XXXX" required>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 2 -->
                        <div class="card p-6">
                            <h3 class="font-bold text-brand-800 border-b border-slate-100 pb-3 mb-4 flex items-center"><i data-lucide="file-text" class="w-5 h-5 mr-2"></i> 2. Detalhes da Ocorrência</h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="input-label required-label">Fato Gerador (Resumo)</label>
                                    <input type="text" id="reg-fato" class="input-field font-medium" placeholder="Ex: Publicação negativa no Instagram" required>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="input-label required-label">Data do Ocorrido</label>
                                        <input type="datetime-local" id="reg-data-ocorrido" class="input-field" required>
                                    </div>
                                    <div>
                                        <label class="input-label required-label">Setor Envolvido</label>
                                        <input type="text" id="reg-setor" class="input-field" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="input-label">Origem da Crise</label>
                                        <select id="reg-origem" class="input-field">
                                            <option value="Externa">Externa</option>
                                            <option value="Interna">Interna</option>
                                            <option value="Mista">Mista</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="input-label">Reincidência?</label>
                                        <div class="flex gap-4 mt-2">
                                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="reincidencia" value="Sim" class="text-brand-600 focus:ring-brand-500"> <span>Sim</span></label>
                                            <label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="reincidencia" value="Não" class="text-brand-600 focus:ring-brand-500" checked> <span>Não</span></label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="input-label mb-2">Público Afetado (Múltipla Escolha)</label>
                                    <div class="grid grid-cols-2 gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="publico" value="Colaboradores" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Colaboradores</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="publico" value="Parceiros" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Parceiros</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="publico" value="Clientes" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Clientes</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="publico" value="Sociedade em Geral" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Sociedade em Geral</span></label>
                                    </div>
                                </div>

                                <div>
                                    <label class="input-label mb-2">Canais de Detecção</label>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="E-mail" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">E-mail</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Instagram" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Instagram</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Imprensa" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Imprensa</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Glassdoor" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Glassdoor</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="LinkedIn" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">LinkedIn</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="WhatsApp" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">WhatsApp</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Google" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Google</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Youtube" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Youtube</span></label>
                                        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" name="canal" value="Outros" class="rounded text-brand-600 focus:ring-brand-500"> <span class="text-sm">Outros</span></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 3 -->
                        <div class="card p-6">
                            <h3 class="font-bold text-brand-800 border-b border-slate-100 pb-3 mb-4 flex items-center"><i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> 3. Classificação e Impacto</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="input-label required-label">Nível de Gravidade</label>
                                    <select id="reg-classificacao" class="input-field font-medium text-slate-700" required>
                                        <option value="">Selecione...</option>
                                        <option value="Sem Relevância Crítica">1 - Sem Relevância Crítica</option>
                                        <option value="Potencial">2 - Potencial</option>
                                        <option value="Moderada">3 - Moderada</option>
                                        <option value="Grave">4 - Grave</option>
                                        <option value="Extrema / Reputacional">5 - Reputacional Extrema</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="input-label mb-2">Impacto Estimado</label>
                                    <div class="flex flex-wrap gap-2">
                                        <label class="inline-flex items-center px-3 py-1.5 bg-white border rounded-full text-sm text-slate-600 hover:bg-slate-50 cursor-pointer transition border-slate-300 has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50 has-[:checked]:text-brand-700">
                                            <input type="checkbox" name="impacto" value="Reputacional" class="mr-2 text-brand-600 rounded focus:ring-brand-500"> Reputacional
                                        </label>
                                        <label class="inline-flex items-center px-3 py-1.5 bg-white border rounded-full text-sm text-slate-600 hover:bg-slate-50 cursor-pointer transition border-slate-300 has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50 has-[:checked]:text-brand-700">
                                            <input type="checkbox" name="impacto" value="Financeiro" class="mr-2 text-brand-600 rounded focus:ring-brand-500"> Financeiro
                                        </label>
                                        <label class="inline-flex items-center px-3 py-1.5 bg-white border rounded-full text-sm text-slate-600 hover:bg-slate-50 cursor-pointer transition border-slate-300 has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50 has-[:checked]:text-brand-700">
                                            <input type="checkbox" name="impacto" value="Jurídico" class="mr-2 text-brand-600 rounded focus:ring-brand-500"> Jurídico
                                        </label>
                                        <label class="inline-flex items-center px-3 py-1.5 bg-white border rounded-full text-sm text-slate-600 hover:bg-slate-50 cursor-pointer transition border-slate-300 has-[:checked]:border-brand-500 has-[:checked]:bg-brand-50 has-[:checked]:text-brand-700">
                                            <input type="checkbox" name="impacto" value="Operacional" class="mr-2 text-brand-600 rounded focus:ring-brand-500"> Operacional
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seção 4 -->
                        <div class="card p-6">
                            <h3 class="font-bold text-brand-800 border-b border-slate-100 pb-3 mb-4 flex items-center"><i data-lucide="shield" class="w-5 h-5 mr-2"></i> 4. Resposta e Ações</h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="input-label required-label">Descrição Objetiva do Ocorrido</label>
                                    <textarea id="reg-desc" rows="4" class="input-field resize-none" placeholder="Contexto completo, envolvidos e timeline inicial..." required></textarea>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="input-label">Medidas Tomadas Até o Momento</label>
                                        <textarea id="reg-acoes" rows="3" class="input-field resize-none" placeholder="Ex: remoção de conteúdo, nota oficial preliminar, resposta direta ao público afetado, contenção..."></textarea>
                                    </div>
                                    <div>
                                        <label class="input-label">Plano de Ação em Execução</label>
                                        <textarea id="reg-plano" rows="3" class="input-field resize-none" placeholder="Ex: Elaboração de nota, reunião extraordinária..."></textarea>
                                    </div>
                                </div>
                                <div>
                                    <label class="input-label mb-2">Equipe Designada</label>
                                    <div class="flex flex-wrap gap-3">
                                        <label class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="equipe" value="Porta-voz" class="mr-2 text-brand-600"> Porta-voz</label>
                                        <label class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="equipe" value="Comunicação externa" class="mr-2 text-brand-600"> Comunicação externa</label>
                                        <label class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="equipe" value="Jurídico" class="mr-2 text-brand-600"> Jurídico</label>
                                        <label class="inline-flex items-center px-3 py-1.5 border rounded-lg text-sm bg-white hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="equipe" value="Monitoramento de mídia" class="mr-2 text-brand-600"> Monitoramento de mídia</label>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="input-label">Monitoramento e Métricas</label>
                                        <textarea id="reg-metricas" rows="2" class="input-field" placeholder="Ex: Reunião com stakeholders, campanha de recuperação..."></textarea>
                                    </div>
                                    <div>
                                        <label class="input-label">Encaminhamentos Futuros</label>
                                        <textarea id="reg-futuro" rows="2" class="input-field" placeholder="Ex: Crescimento de menções negativas, perda de seguidores..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões -->
                        <div class="flex justify-end gap-4 pt-4">
                            <button type="button" onclick="Router.navigate('dashboard')" class="btn btn-secondary px-6">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-8 transform hover:-translate-y-0.5">
                                <i data-lucide="save" class="w-4 h-4"></i> Salvar Boletim
                            </button>
                        </div>
                    </form>
                </div>

                <!-- VIEW: GRÁFICOS (NOVA) -->
                <div id="view-charts" class="view-page hidden space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">Análise Gráfica Detalhada</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="card p-6">
                            <h3 class="font-bold text-slate-800 mb-4">Canais de Detecção</h3>
                            <div class="h-72 w-full"><canvas id="chart-channels"></canvas></div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-bold text-slate-800 mb-4">Impacto por Tipo</h3>
                            <div class="h-72 w-full flex justify-center"><canvas id="chart-impact"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: RELATÓRIOS (NOVA) -->
                <div id="view-reports" class="view-page hidden space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">Relatórios</h2>
                    <div class="card p-10 text-center border-2 border-dashed border-slate-300">
                        <i data-lucide="file-text" class="w-16 h-16 mx-auto text-slate-300 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-700 mb-2">Exportar Relatório Completo</h3>
                        <p class="text-slate-500 mb-6">Gera um arquivo PDF com todos os dados e estatísticas atuais do sistema.</p>
                        <button onclick="ReportsService.exportFullReport()" class="btn btn-primary mx-auto">
                            <i data-lucide="download" class="w-4 h-4"></i> Baixar PDF
                        </button>
                    </div>
                </div>

                <!-- VIEW: CONFIG (NOVA) -->
                <div id="view-config" class="view-page hidden space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">Configurações</h2>
                    <div class="card p-6">
                        <h3 class="font-bold text-slate-800 mb-4">Perfil de Usuário</h3>
                        <div class="flex items-center p-4 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="w-12 h-12 bg-brand-100 text-brand-600 rounded-full flex items-center justify-center font-bold text-xl mr-4">U</div>
                            <div>
                                <p class="font-bold text-slate-800">Administrador</p>
                                <p class="text-sm text-slate-500">admin@evereste.org.br</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- LÓGICA JAVASCRIPT (SEGURANÇA, DADOS E RENDERIZAÇÃO) -->
    <script>
        const Security = {
            PASS_HASH: '5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8', // Hash fake para demo
            sanitize: (str) => {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },
            hash: async (message) => {
                return message === "Evereste@2025" ? Security.PASS_HASH : "invalid";
            }
        };

        const Toast = {
            show: (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'alert-circle' : 'info');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> ${Security.sanitize(message)}`;
                container.appendChild(toast);
                lucide.createIcons();
                requestAnimationFrame(() => toast.classList.add('show'));
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        };

        const Modal = {
            callback: null,
            open: (title, desc, confirmCallback) => {
                document.getElementById('modal-title').innerText = title;
                document.getElementById('modal-desc').innerText = desc;
                Modal.callback = confirmCallback;
                document.getElementById('confirm-modal').classList.add('show');
            },
            close: () => {
                document.getElementById('confirm-modal').classList.remove('show');
                Modal.callback = null;
            }
        };

        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if(Modal.callback) Modal.callback();
            Modal.close();
        });

        const AuthService = {
            state: { step: 1 },
            login: async (e) => {
                e.preventDefault();
                if (AuthService.state.step === 1) {
                    const email = document.getElementById('email').value;
                    const pass = document.getElementById('password').value;
                    if (!email.endsWith('@evereste.org.br')) {
                        Toast.show("Acesso permitido apenas para e-mails corporativos.", "error");
                        return;
                    }
                    const passHash = await Security.hash(pass);
                    if (passHash === Security.PASS_HASH) {
                        document.getElementById('email').disabled = true;
                        document.getElementById('password').disabled = true;
                        document.getElementById('2fa-container').classList.remove('hidden');
                        document.getElementById('login-btn').innerHTML = 'Validar Token de Segurança';
                        AuthService.state.step = 2;
                        Toast.show("Credenciais válidas. Insira o token 2FA.", "info");
                    } else {
                        Toast.show("Credenciais inválidas.", "error");
                    }
                } else {
                    const code = document.getElementById('2fa-code').value;
                    if (code === "123456") {
                        sessionStorage.setItem('auth_token', 'secure_session_' + Date.now());
                        Toast.show("Sessão segura iniciada.", "success");
                        Router.init();
                    } else {
                        Toast.show("Token de segurança inválido.", "error");
                    }
                }
            },
            logout: () => {
                Modal.open("Encerrar Sessão", "Deseja realmente sair do sistema?", () => {
                    sessionStorage.removeItem('auth_token');
                    window.location.reload();
                });
            }
        };

        const Router = {
            init: () => {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                lucide.createIcons();
                App.init();
            },
            navigate: (viewId) => {
                document.querySelectorAll('.view-page').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${viewId}`);
                if (target) target.classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('bg-slate-800', 'text-white');
                    el.classList.add('text-slate-300');
                });
                const active = document.getElementById(`nav-${viewId}`);
                if(active) {
                    active.classList.remove('text-slate-300');
                    active.classList.add('bg-slate-800', 'text-white');
                }

                if(viewId === 'dashboard') App.updateDashboard();
                if(viewId === 'dashboard' || viewId === 'charts') {
                    setTimeout(() => App.updateDashboard(), 100);
                }
            }
        };

        const DB = {
            data: JSON.parse(localStorage.getItem('evereste_crises_db')) || [],
            save: () => {
                localStorage.setItem('evereste_crises_db', JSON.stringify(DB.data));
            },
            add: (record) => {
                DB.data.unshift(record);
                DB.data.sort((a, b) => new Date(b.data) - new Date(a.data)); 
                DB.save();
            },
            delete: (id) => {
                DB.data = DB.data.filter(r => r.id !== id);
                DB.save();
            }
        };

        const App = {
            charts: {},
            init: () => {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('reg-data').value = now.toISOString().slice(0,16);
                App.renderTable();
                App.updateDashboard();
                Router.navigate('dashboard');
            },
            askClearAll: () => {
                Modal.open("Apagar Tudo", "Isso excluirá PERMANENTEMENTE todos os registros. Tem certeza?", () => {
                    DB.data = [];
                    DB.save();
                    App.renderTable();
                    App.updateDashboard();
                    Toast.show("Todos os dados foram apagados.", "warning");
                });
            },
            askDeleteRow: (id) => {
                Modal.open("Excluir Registro", "Deseja apagar este boletim de ocorrência?", () => {
                    DB.delete(id);
                    App.renderTable();
                    App.updateDashboard();
                    Toast.show('Registro removido.', 'success');
                });
            },
            submitForm: (e) => {
                e.preventDefault();
                const newRec = {
                    id: `BO-${new Date().getFullYear()}-${String(Math.floor(Math.random()*10000)).padStart(4,'0')}`,
                    data: document.getElementById('reg-data').value || document.getElementById('reg-data-ocorrido').value,
                    fato: document.getElementById('reg-fato').value,
                    resp: document.getElementById('reg-resp').value,
                    class: document.getElementById('reg-classificacao').value,
                    status: 'Nova',
                    setor: document.getElementById('reg-setor').value,
                    origem: document.getElementById('reg-origem').value,
                    reincidencia: document.querySelector('input[name="reincidencia"]:checked').value,
                    publico: Array.from(document.querySelectorAll('input[name="publico"]:checked')).map(c=>c.value).join(', '),
                    desc: document.getElementById('reg-desc').value,
                    acoes: document.getElementById('reg-acoes').value,
                    equipe: Array.from(document.querySelectorAll('input[name="equipe"]:checked')).map(c=>c.value).join(', '),
                    plano: document.getElementById('reg-plano').value,
                    metricas: document.getElementById('reg-metricas').value,
                    futuro: document.getElementById('reg-futuro').value,
                    impacto: Array.from(document.querySelectorAll('input[name="impacto"]:checked')).map(c=>c.value),
                    canais: Array.from(document.querySelectorAll('input[name="canal"]:checked')).map(c=>c.value)
                };
                DB.add(newRec);
                Toast.show(`Ocorrência ${newRec.id} registrada com sucesso.`);
                e.target.reset();
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('reg-data').value = now.toISOString().slice(0,16);
                App.renderTable();
                App.updateDashboard();
                Router.navigate('list');
            },
            renderTable: () => {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                const term = document.getElementById('search-input').value.toLowerCase();
                DB.data.filter(r => 
                    r.fato.toLowerCase().includes(term) || 
                    r.id.toLowerCase().includes(term) ||
                    r.resp.toLowerCase().includes(term)
                ).forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 transition border-b border-slate-100";
                    let badge = 'bg-slate-100 text-slate-600';
                    if(row.class.includes('Extrema')) badge = 'bg-red-100 text-red-700 ring-1 ring-red-600/20';
                    else if(row.class.includes('Grave')) badge = 'bg-orange-100 text-orange-700 ring-1 ring-orange-600/20';
                    else if(row.class.includes('Moderada')) badge = 'bg-amber-100 text-amber-700 ring-1 ring-amber-600/20';
                    tr.innerHTML = `
                        <td class="px-6 py-4 font-mono text-xs text-slate-500">${row.id}</td>
                        <td class="px-6 py-4 text-slate-700">${new Date(row.data).toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-medium text-slate-800 max-w-xs truncate">${Security.sanitize(row.fato)}</td>
                        <td class="px-6 py-4 text-slate-600">${Security.sanitize(row.resp)}</td>
                        <td class="px-6 py-4"><span class="px-2.5 py-0.5 rounded-full text-xs font-bold ${badge}">${Security.sanitize(row.class)}</span></td>
                        <td class="px-6 py-4 text-slate-500 text-xs">${row.status}</td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick="ReportsService.exportSingle('${row.id}')" class="p-1.5 text-brand-600 hover:bg-brand-50 rounded transition" title="PDF"><i data-lucide="file-down" class="w-4 h-4"></i></button>
                            <button onclick="App.askDeleteRow('${row.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded transition" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('table-counter').innerText = `${DB.data.length} registros encontrados`;
                lucide.createIcons();
            },
            sort: (field) => {
                DB.data.reverse(); 
                App.renderTable();
            },
            updateDashboard: () => {
                document.getElementById('kpi-active').innerText = DB.data.length;
                document.getElementById('kpi-total').innerText = DB.data.length;
                document.getElementById('kpi-resolved').innerText = "0"; 
                
                setTimeout(() => {
                    const trendCanvas = document.getElementById('chart-trend');
                    const severityCanvas = document.getElementById('chart-severity');
                    const channelsCanvas = document.getElementById('chart-channels');
                    const impactCanvas = document.getElementById('chart-impact');

                    if(App.charts.trend) App.charts.trend.destroy();
                    if(App.charts.severity) App.charts.severity.destroy();
                    if(App.charts.channels) App.charts.channels.destroy();
                    if(App.charts.impact) App.charts.impact.destroy();

                    const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } };

                    if(trendCanvas) {
                        const ctxT = trendCanvas.getContext('2d');
                        App.charts.trend = new Chart(ctxT, {
                            type: 'line',
                            data: {
                                labels: ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                                datasets: [{
                                    label: 'Ocorrências',
                                    data: [0, 0, 0, 0, 0, DB.data.length], 
                                    borderColor: '#2563eb',
                                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: commonOptions
                        });
                    }

                    if(severityCanvas) {
                        const ctxS = severityCanvas.getContext('2d');
                        let counts = { 'Extrema':0, 'Grave':0, 'Moderada':0, 'Baixa':0 };
                        DB.data.forEach(r => {
                            if(r.class.includes('Extrema')) counts['Extrema']++;
                            else if(r.class.includes('Grave')) counts['Grave']++;
                            else if(r.class.includes('Moderada')) counts['Moderada']++;
                            else counts['Baixa']++;
                        });
                        App.charts.severity = new Chart(ctxS, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(counts),
                                datasets: [{
                                    data: Object.values(counts),
                                    backgroundColor: ['#dc2626', '#ea580c', '#d97706', '#2563eb']
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }

                    if(channelsCanvas) {
                        const ctxC = channelsCanvas.getContext('2d');
                        App.charts.channels = new Chart(ctxC, {
                            type: 'bar',
                            data: {
                                labels: ['Instagram', 'LinkedIn', 'Imprensa', 'WhatsApp', 'Glassdoor', 'Youtube'],
                                datasets: [{
                                    label: 'Ocorrências',
                                    data: [0,0,0,0,0,0], 
                                    backgroundColor: ['#E1306C', '#0077b5', '#1d4ed8', '#25D366', '#0caa41', '#FF0000']
                                }]
                            },
                            options: commonOptions
                        });
                    }

                    if(impactCanvas) {
                        const ctxI = impactCanvas.getContext('2d');
                        App.charts.impact = new Chart(ctxI, {
                            type: 'pie',
                            data: {
                                labels: ['Reputacional', 'Financeiro', 'Jurídico'],
                                datasets: [{
                                    data: [0, 0, 0], 
                                    backgroundColor: ['#8b5cf6', '#10b981', '#f59e0b']
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                }, 100);
            }
        };

        const ReportsService = {
            exportSingle: (id) => {
                const r = DB.data.find(x => x.id === id);
                if(!r) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFillColor(30, 58, 138); 
                doc.rect(0, 0, 210, 24, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('BOLETIM DE OCORRÊNCIA', 14, 15);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.text('INSTITUTO EVERESTE - GESTÃO DE CRISE DE IMAGEM', 200, 15, { align: 'right' });
                doc.setTextColor(30, 41, 59);
                let y = 40;
                const addBlock = (title, content) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(37, 99, 235);
                    doc.text(title.toUpperCase(), 14, y);
                    doc.line(14, y+1, 196, y+1);
                    y += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(51, 65, 85);
                    const lines = doc.splitTextToSize(String(content || '-'), 180);
                    doc.text(lines, 14, y);
                    y += (lines.length * 5) + 8;
                };
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`ID: ${r.id}`, 14, y);
                doc.text(`Data: ${new Date(r.data).toLocaleString()}`, 150, y);
                y += 10;
                addBlock('1. Fato Gerador', r.fato);
                addBlock('2. Detalhes de Registro', `Responsável: ${r.resp}\nSetor: ${r.setor || '-'}\nOrigem: ${r.origem || '-'}\nReincidência: ${r.reincidencia}\nPúblico Afetado: ${r.publico || '-'}`);
                addBlock('3. Classificação de Risco', `Nível: ${r.class}\nCanais: ${r.canais ? r.canais.join(', ') : '-'}\nImpacto: ${r.impacto ? r.impacto.join(', ') : '-'}`);
                addBlock('4. Descrição Completa', r.desc);
                addBlock('5. Ações e Resposta', `Medidas Tomadas: ${r.acoes || '-'}\nEquipe Designada: ${r.equipe || '-'}\nPlano de Ação: ${r.plano || '-'}`);
                addBlock('6. Monitoramento e Métricas', `Métricas: ${r.metricas || '-'}`);
                addBlock('7. Encaminhamentos Futuros', `Encaminhamentos: ${r.futuro || '-'}`);
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`Documento confidencial gerado em ${new Date().toLocaleString()}`, 14, 285);
                doc.save(`${r.id}.pdf`);
                Toast.show('PDF baixado com sucesso.');
            },
            exportFullReport: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Relatório Geral de Crises - Evereste", 14, 15);
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 22);
                const headers = [['ID', 'Data', 'Fato', 'Resp.', 'Risco', 'Status']];
                const rows = DB.data.map(r => [
                    r.id, 
                    new Date(r.data).toLocaleDateString(), 
                    r.fato, 
                    r.resp, 
                    r.class, 
                    r.status
                ]);
                doc.autoTable({
                    head: headers,
                    body: rows,
                    startY: 30,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 58, 138] },
                    styles: { fontSize: 8 }
                });
                doc.save('Relatorio_Geral_Evereste.pdf');
                Toast.show('Relatório geral baixado.');
            }
        };

        if (sessionStorage.getItem('auth_token')) {
            AuthService.state.step = 2;
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            App.init();
        }
    </script>
</body>
</html>
